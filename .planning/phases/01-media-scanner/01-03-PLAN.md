---
phase: 01-media-scanner
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/filters/aspectRatio.ts
  - src/filters/duplicate.ts
autonomous: true

must_haves:
  truths:
    - "Aspect ratio filter correctly identifies 16:9 content with tolerance"
    - "Duplicate detector identifies files with identical SHA-256 hashes"
    - "Duplicate groups contain 2+ files (actual duplicates only)"
  artifacts:
    - path: "src/filters/aspectRatio.ts"
      provides: "16:9 aspect ratio filtering logic"
      exports: ["is16by9", "ASPECT_RATIO_16_9", "ASPECT_RATIO_TOLERANCE"]
    - path: "src/filters/duplicate.ts"
      provides: "Hash-based duplicate detection"
      exports: ["hashFile", "findDuplicates"]
  key_links:
    - from: "src/filters/duplicate.ts"
      to: "node:crypto"
      via: "import"
      pattern: "createHash"
---

<objective>
Implement aspect ratio filtering and duplicate detection modules.

Purpose: Create the filter logic that identifies 16:9 content and detects duplicate files using SHA-256 hashing.
Output: Two filter modules that can be used by the scanner to filter matches and flag duplicates.
</objective>

<execution_context>
@/Users/jamessink/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamessink/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-media-scanner/01-RESEARCH.md
@.planning/phases/01-media-scanner/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create aspect ratio filter</name>
  <files>src/filters/aspectRatio.ts</files>
  <action>
Create src/filters/aspectRatio.ts with 16:9 filtering logic:

```typescript
// 16:9 = 1.777... (16 / 9)
export const ASPECT_RATIO_16_9 = 16 / 9;

// Tolerance for floating point comparison
// 0.01 allows for minor variations (e.g., 1920x1080 vs 1920x1079)
export const ASPECT_RATIO_TOLERANCE = 0.01;

/**
 * Check if an aspect ratio matches 16:9 within tolerance
 */
export function is16by9(aspectRatio: number): boolean {
  return Math.abs(aspectRatio - ASPECT_RATIO_16_9) < ASPECT_RATIO_TOLERANCE;
}

/**
 * Calculate aspect ratio from dimensions
 */
export function calculateAspectRatio(width: number, height: number): number {
  if (height === 0) return 0;
  return width / height;
}

/**
 * Check if dimensions match 16:9
 */
export function isDimensions16by9(width: number, height: number): boolean {
  return is16by9(calculateAspectRatio(width, height));
}
```

Key implementation details:
- Use tolerance-based comparison (RESEARCH.md pitfall #4)
- Export constants for use in tests and other modules
- Handle edge case of height=0 to avoid division by zero
  </action>
  <verify>
Test with known values:
- is16by9(1920/1080) should return true (1.777...)
- is16by9(1920/1200) should return false (1.6)
- is16by9(3840/2160) should return true (4K 16:9)
- is16by9(1080/1920) should return false (portrait)
  </verify>
  <done>src/filters/aspectRatio.ts provides 16:9 detection with tolerance-based comparison</done>
</task>

<task type="auto">
  <name>Task 2: Create duplicate detection with SHA-256 hashing</name>
  <files>src/filters/duplicate.ts</files>
  <action>
Create src/filters/duplicate.ts implementing streaming hash from RESEARCH.md:

```typescript
import { createReadStream } from 'node:fs';
import { createHash } from 'node:crypto';
import { DuplicateGroup } from '../types.js';

/**
 * Calculate SHA-256 hash of a file using streaming (constant memory)
 */
export async function hashFile(filePath: string): Promise<string> {
  return new Promise((resolve, reject) => {
    const hash = createHash('sha256');
    // 256KB chunks for optimal performance
    const stream = createReadStream(filePath, { highWaterMark: 256 * 1024 });

    stream.on('data', (chunk) => hash.update(chunk));
    stream.on('end', () => resolve(hash.digest('hex')));
    stream.on('error', reject);
  });
}

/**
 * Find duplicate files by hash
 * Returns groups where count >= 2 (actual duplicates)
 */
export async function findDuplicates(
  files: string[],
  onProgress?: (current: number, total: number) => void
): Promise<DuplicateGroup[]> {
  const hashMap = new Map<string, string[]>();

  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    try {
      const hash = await hashFile(file);
      const existing = hashMap.get(hash) || [];
      existing.push(file);
      hashMap.set(hash, existing);
    } catch (error) {
      // Skip files that can't be hashed (permissions, deleted, etc.)
      console.warn(`Could not hash ${file}: ${(error as Error).message}`);
    }

    if (onProgress) {
      onProgress(i + 1, files.length);
    }
  }

  // Only return groups with 2+ files (actual duplicates)
  return Array.from(hashMap.entries())
    .filter(([_, files]) => files.length > 1)
    .map(([hash, files]) => ({
      hash,
      files,
      count: files.length
    }));
}

/**
 * Mark duplicates in a list of MediaInfo objects
 * First file in each group is considered the "original"
 */
export function markDuplicates(
  files: Array<{ path: string; hash?: string }>,
  duplicates: DuplicateGroup[]
): void {
  const duplicateMap = new Map<string, string>();

  for (const group of duplicates) {
    const original = group.files[0];
    for (let i = 1; i < group.files.length; i++) {
      duplicateMap.set(group.files[i], original);
    }
  }

  for (const file of files) {
    if (file.hash && duplicateMap.has(file.path)) {
      (file as any).isDuplicate = true;
      (file as any).duplicateOf = duplicateMap.get(file.path);
    }
  }
}
```

Key implementation details:
- Use streaming to maintain constant memory (RESEARCH.md pitfall #3)
- 256KB highWaterMark for optimal I/O performance
- Skip unreadable files with warning (don't crash)
- onProgress callback for progress reporting during scan
- markDuplicates helper to annotate MediaInfo objects
  </action>
  <verify>
Test hashFile with a known file:
```typescript
const hash = await hashFile('./package.json');
console.log(hash.length === 64); // SHA-256 = 64 hex chars
```
Test findDuplicates with duplicate files (copy a file and check it's detected)
  </verify>
  <done>src/filters/duplicate.ts provides streaming SHA-256 hashing and duplicate group detection</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. is16by9(1920/1080) returns true
3. is16by9(1920/1200) returns false
4. hashFile returns 64-character hex string
5. findDuplicates returns empty array when no duplicates
6. findDuplicates returns groups with count >= 2 when duplicates exist
</verification>

<success_criteria>
- Aspect ratio filter uses tolerance-based comparison (not exact equality)
- is16by9 correctly identifies 16:9 content (1920x1080, 3840x2160, etc.)
- hashFile uses streaming to maintain constant memory
- findDuplicates only returns groups with 2+ files
- Both modules handle errors gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/01-media-scanner/01-03-SUMMARY.md`
</output>
