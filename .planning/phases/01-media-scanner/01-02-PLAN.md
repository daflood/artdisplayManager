---
phase: 01-media-scanner
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/readers/base.ts
  - src/readers/image.ts
  - src/readers/video.ts
autonomous: true

must_haves:
  truths:
    - "Image reader extracts width, height, and format from image files"
    - "Image reader handles EXIF orientation (tags 5-8 swap width/height)"
    - "Video reader extracts width, height from video files"
    - "Video reader handles rotation metadata (90/270 swap dimensions)"
    - "Both readers return null for corrupted/unreadable files without crashing"
  artifacts:
    - path: "src/readers/base.ts"
      provides: "Common interface for readers"
      exports: ["MediaReader"]
    - path: "src/readers/image.ts"
      provides: "sharp-based image metadata extraction"
      exports: ["readImage"]
    - path: "src/readers/video.ts"
      provides: "ffprobe-based video metadata extraction"
      exports: ["readVideo"]
  key_links:
    - from: "src/readers/image.ts"
      to: "sharp"
      via: "import"
      pattern: "import sharp"
    - from: "src/readers/video.ts"
      to: "@ffprobe-installer/ffprobe"
      via: "import"
      pattern: "ffprobe"
---

<objective>
Implement image and video metadata readers that extract dimensions and handle rotation metadata.

Purpose: Create the core readers that extract width, height, aspect ratio, and format from media files, handling EXIF orientation for images and rotation tags for videos.
Output: Two reader modules (image.ts, video.ts) that return MediaInfo or null for unreadable files.
</objective>

<execution_context>
@/Users/jamessink/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamessink/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-media-scanner/01-RESEARCH.md
@.planning/phases/01-media-scanner/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create image reader with EXIF orientation handling</name>
  <files>src/readers/base.ts, src/readers/image.ts</files>
  <action>
Create src/readers/base.ts with common interface:
```typescript
import { MediaInfo } from '../types.js';

export interface MediaReader {
  canHandle(filePath: string): boolean;
  read(filePath: string): Promise<MediaInfo | null>;
}
```

Create src/readers/image.ts implementing the pattern from RESEARCH.md:
- Use sharp to extract metadata (width, height, format, orientation)
- Handle EXIF orientation tags 5-8 by swapping width/height
- Use fs.stat to get file size
- Calculate aspectRatio as width/height (after orientation correction)
- Determine is16by9 using tolerance comparison: Math.abs(aspectRatio - 16/9) < 0.01
- Wrap in try-catch, return null on error (log warning to stderr)

Key implementation details:
- Import sharp (default export)
- Check metadata.orientation: if >= 5 and <= 8, dimensions are rotated
- Return MediaInfo with type: 'image'
- Use IMAGE_EXTENSIONS from types.ts for canHandle()
  </action>
  <verify>
Create a simple test: place a JPEG file in test-files/ and run:
```typescript
// Quick verification (can be run with npx tsx)
import { readImage } from './src/readers/image.js';
const result = await readImage('./test-files/sample.jpg');
console.log(result);
```
Check: Returns MediaInfo object with width, height, aspectRatio, is16by9
  </verify>
  <done>src/readers/image.ts extracts image metadata with EXIF orientation handling, returns null for unreadable files</done>
</task>

<task type="auto">
  <name>Task 2: Create video reader with rotation handling</name>
  <files>src/readers/video.ts</files>
  <action>
Create src/readers/video.ts implementing the pattern from RESEARCH.md:
- Import @ffprobe-installer/ffprobe for static binary path
- Use child_process.exec to run ffprobe command
- Command: ffprobe -v error -select_streams v:0 -show_entries stream=width,height,codec_name:stream_tags=rotate -of json "filepath"
- Parse JSON output to extract width, height, codec_name
- Check stream.tags?.rotate: if 90 or 270, swap width/height
- Use fs.stat to get file size
- Calculate aspectRatio and is16by9 with same tolerance as image reader
- Wrap in try-catch, return null on error (log warning to stderr)

Key implementation details:
- Use promisify(exec) for async/await
- Quote the file path in command to handle spaces
- Handle case where ffprobe returns no streams (return null)
- Use VIDEO_EXTENSIONS from types.ts for canHandle()
- Return MediaInfo with type: 'video', format = codec_name
  </action>
  <verify>
Create a simple test: place an MP4 file in test-files/ and run:
```typescript
import { readVideo } from './src/readers/video.js';
const result = await readVideo('./test-files/sample.mp4');
console.log(result);
```
Check: Returns MediaInfo object with width, height, aspectRatio, codec
  </verify>
  <done>src/readers/video.ts extracts video metadata with rotation handling, returns null for unreadable files</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (all code compiles)
2. Image reader correctly handles EXIF orientation (test with rotated image if available)
3. Video reader correctly parses ffprobe output
4. Both readers return null for invalid/corrupted files without throwing
5. Both readers calculate is16by9 with tolerance-based comparison
</verification>

<success_criteria>
- src/readers/image.ts extracts width, height, format from images
- Image reader swaps dimensions for EXIF orientation 5-8
- src/readers/video.ts extracts width, height, codec from videos
- Video reader swaps dimensions for rotation 90/270
- Both return null (not throw) for unreadable files
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-media-scanner/01-02-SUMMARY.md`
</output>
