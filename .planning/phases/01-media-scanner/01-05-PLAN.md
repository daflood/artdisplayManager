---
phase: 01-media-scanner
plan: 05
type: execute
wave: 4
depends_on: ["01-04"]
files_modified:
  - src/cli.ts
autonomous: true

must_haves:
  truths:
    - "CLI accepts one or more directory paths as arguments"
    - "CLI shows progress during scanning"
    - "CLI outputs results to stdout or specified file"
    - "CLI supports both JSON and CSV output formats"
    - "CLI has --no-duplicates flag to skip duplicate detection"
    - "Built scanner can be run with npx or npm start"
  artifacts:
    - path: "src/cli.ts"
      provides: "CLI entry point with commander"
      min_lines: 50
  key_links:
    - from: "src/cli.ts"
      to: "src/scanner.ts"
      via: "import"
      pattern: "scanDirectories"
    - from: "src/cli.ts"
      to: "commander"
      via: "import"
      pattern: "Command"
    - from: "package.json"
      to: "src/cli.ts"
      via: "bin field"
      pattern: "dist/cli.js"
---

<objective>
Implement the CLI entry point that ties all components together into a usable command-line tool.

Purpose: Create the user-facing CLI that accepts directory arguments, shows progress, and outputs results in the requested format.
Output: Complete CLI tool that can be built and run with `npm start` or `npx media-scanner`.
</objective>

<execution_context>
@/Users/jamessink/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamessink/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-media-scanner/01-RESEARCH.md
@.planning/phases/01-media-scanner/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CLI entry point with commander</name>
  <files>src/cli.ts</files>
  <action>
Create src/cli.ts implementing the CLI pattern from RESEARCH.md:

```typescript
#!/usr/bin/env node

import { Command } from 'commander';
import ora from 'ora';
import chalk from 'chalk';
import { scanDirectories, ScanCallbacks } from './scanner.js';
import { formatJson, writeJson } from './output/json.js';
import { formatCsv, writeCsv } from './output/csv.js';
import { ScanOptions } from './types.js';

const program = new Command();

program
  .name('media-scanner')
  .description('Scan directories for 16:9 aspect ratio media files')
  .version('1.0.0')
  .argument('<directories...>', 'Directories to scan')
  .option('-o, --output <file>', 'Output file path (default: stdout)')
  .option('-f, --format <type>', 'Output format: json or csv', 'json')
  .option('--no-duplicates', 'Skip duplicate detection')
  .option('-c, --concurrency <number>', 'Concurrent file processing limit', '25')
  .action(async (directories: string[], opts) => {
    const options: ScanOptions = {
      output: opts.output,
      format: opts.format as 'json' | 'csv',
      duplicates: opts.duplicates !== false,
      concurrency: parseInt(opts.concurrency, 10)
    };

    // Validate directories exist
    // (scanner will warn for inaccessible ones)

    const spinner = ora();
    let totalFiles = 0;

    const callbacks: ScanCallbacks = {
      onFileFound: (count) => {
        totalFiles = count;
        spinner.text = `Finding files... ${count} found`;
      },
      onFileProcessed: (current, total, file) => {
        const pct = Math.round((current / total) * 100);
        spinner.text = `Processing files [${pct}%] ${current}/${total}`;
      },
      onHashProgress: (current, total) => {
        const pct = Math.round((current / total) * 100);
        spinner.text = `Detecting duplicates [${pct}%] ${current}/${total}`;
      }
    };

    console.log(chalk.blue('Media Scanner v1.0.0'));
    console.log(chalk.gray(`Scanning: ${directories.join(', ')}`));
    console.log();

    spinner.start('Finding files...');

    try {
      const result = await scanDirectories(directories, options, callbacks);
      spinner.succeed(`Scan complete!`);

      // Print summary
      console.log();
      console.log(chalk.green(`Results:`));
      console.log(`  Total files scanned: ${result.stats.totalFiles}`);
      console.log(`  Images processed: ${result.stats.imagesProcessed}`);
      console.log(`  Videos processed: ${result.stats.videosProcessed}`);
      console.log(`  ${chalk.bold(`16:9 matches: ${result.stats.matchCount}`)}`);
      if (options.duplicates) {
        console.log(`  Duplicates found: ${result.stats.duplicateCount}`);
      }
      if (result.stats.skippedCount > 0) {
        console.log(chalk.yellow(`  Skipped (errors): ${result.stats.skippedCount}`));
      }
      console.log(`  Duration: ${(result.stats.scanDuration / 1000).toFixed(1)}s`);
      console.log();

      // Output results
      if (options.output) {
        if (options.format === 'csv') {
          await writeCsv(result, options.output);
        } else {
          await writeJson(result, options.output);
        }
        console.log(chalk.green(`Results written to: ${options.output}`));
      } else {
        // Output to stdout
        if (options.format === 'csv') {
          console.log(formatCsv(result));
        } else {
          console.log(formatJson(result));
        }
      }
    } catch (error) {
      spinner.fail('Scan failed');
      console.error(chalk.red((error as Error).message));
      process.exit(1);
    }
  });

program.parse();
```

Key implementation details:
- Shebang for direct execution
- commander for argument parsing (RESEARCH.md standard stack)
- ora for progress spinner
- chalk for colored output
- Callbacks wire up progress updates to spinner
- Supports both file output and stdout
- Prints summary statistics before results
- Error handling with proper exit code

Update package.json if needed to ensure:
- "bin": { "media-scanner": "./dist/cli.js" }
- "scripts": { "build": "tsc", "start": "node dist/cli.js" }
  </action>
  <verify>
Build and test:
```bash
npm run build
# Test with a directory (create test-files/ with sample media if needed)
npm start -- ./test-files
# Or
node dist/cli.js ./test-files
```
Check:
- Help shown with --help
- Progress spinner updates during scan
- Results output in JSON by default
- --format csv outputs CSV
- -o file.json writes to file
  </verify>
  <done>src/cli.ts provides complete CLI with progress reporting, multiple output formats, and duplicate detection toggle</done>
</task>

<task type="auto">
  <name>Task 2: Build and verify end-to-end functionality</name>
  <files>(no new files - verification task)</files>
  <action>
Build the project and perform end-to-end verification:

1. Run `npm run build` - should compile without errors
2. Create test-files/ directory with sample media:
   - At least one 16:9 image (1920x1080 or similar)
   - At least one non-16:9 image (to verify filtering)
   - Optionally a video file
   - Optionally duplicate a file (to test duplicate detection)
3. Run scanner against test-files/:
   ```bash
   node dist/cli.js ./test-files
   ```
4. Verify:
   - 16:9 images appear in matches
   - Non-16:9 images do NOT appear
   - Duplicates are detected and flagged (if any)
   - JSON output is valid
5. Test CSV output:
   ```bash
   node dist/cli.js ./test-files -f csv
   ```
6. Test file output:
   ```bash
   node dist/cli.js ./test-files -o results.json
   cat results.json
   ```
7. Test --no-duplicates:
   ```bash
   node dist/cli.js ./test-files --no-duplicates
   ```

Document any issues found for future fixes.
  </action>
  <verify>
All commands complete without errors.
JSON output is valid JSON.
CSV output has correct headers.
16:9 filtering works correctly.
Duplicate detection works when enabled.
  </verify>
  <done>Scanner builds and runs successfully, producing correct output for test files</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without TypeScript errors
2. `node dist/cli.js --help` shows usage information
3. Scanner processes test directory and outputs results
4. 16:9 images appear in output, non-16:9 excluded
5. JSON and CSV formats both work
6. File output with -o flag works
7. --no-duplicates skips duplicate detection
8. Progress spinner updates during scan
</verification>

<success_criteria>
- CLI accepts directories and options
- Progress shown during scanning
- JSON output valid and complete
- CSV output properly formatted
- Duplicate detection can be disabled
- Scanner handles errors gracefully
- Can be run via npm start or node dist/cli.js
</success_criteria>

<output>
After completion, create `.planning/phases/01-media-scanner/01-05-SUMMARY.md`
</output>
